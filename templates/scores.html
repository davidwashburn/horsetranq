<!doctype html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;900&display=swap" rel="stylesheet">
		<link rel="icon" type="image/x-icon" href="/static/img/ui/hors.ico">
		<link rel="stylesheet" href="/static/css/reset.css"> <!-- CSS reset -->
		<link rel="stylesheet" href="/static/css/style.css"> <!-- Resource style -->
		<link rel="stylesheet" href="/static/css/variables.css"> <!-- Variables style -->
		<link rel="stylesheet" href="/static/css/style-v3.css"> <!-- New v3 style -->
		<script src="/static/js/resources/modernizr.js"></script> <!-- Modernizr -->
		<script src="https://cdn.auth0.com/js/auth0/9.18/auth0.min.js"></script>
		<script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
		<title>Scors - HOrstRnq</title>
	</head>
	<body>

		<main id="scores" class="main-content">
			{% include 'partials/navigation_menu.html' %}

			<!-- Scores Main Section -->
			<div class="main-wrapper" data-animate="page-intro">
				<div class="hero-section margin-auto-desktop margin-auto-phone margin-auto-tablet width-xl-desktop width-xl-tablet width-xl-phone">
					<div class="flex-row-desktop flex-column-phone flex-align-center flex-justify-center gap-xl-all">
						<!-- WEEKLY LEADERS Column -->
						<div class="flex-column-desktop">
							<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-xl font-weight-xl color-accent-white rotate-left-desktop rotate-left-tablet">WEEKLY LEADERS</h3>
							<div id="hero-square" class="width-full-phone width-full-desktop width-lg-tablet margin-auto-phone margin-auto-tablet border-radius rotate-left-desktop shadow-green-md">
								<div class="flex-column-desktop flex-column-phone flex-justify-center flex-align-items-start width-full-all">
									
									<!-- Most games -->
									<div class="data-item username-link flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet" data-username="{{ weekly_leaders.most_games.username }}" style="cursor: pointer;">
										<h4 class="font-size-md font-weight-xl color-accent-white">Most games</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{{ weekly_leaders.most_games.username }} ({{ weekly_leaders.most_games.games }})
										</p>
									</div>

									<!-- Most horses -->
									<div class="data-item username-link flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet" data-username="{{ weekly_leaders.most_horses.username }}" style="cursor: pointer;">
										<h4 class="font-size-md font-weight-xl color-accent-white">Most horses</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{{ weekly_leaders.most_horses.username }} ({{ weekly_leaders.most_horses.horses }})
										</p>
									</div>

									<!-- Fastest time -->
									<div class="data-item username-link flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet" data-username="{{ weekly_leaders.fastest_time.username }}" style="cursor: pointer;">
										<h4 class="font-size-md font-weight-xl color-accent-white">Fastest time</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{% if weekly_leaders.fastest_time.time_ms %}
												{% set seconds = (weekly_leaders.fastest_time.time_ms / 1000)|int %}
												{% set centiseconds = (weekly_leaders.fastest_time.time_ms % 1000) // 10 %}
												{% set tenths = (weekly_leaders.fastest_time.time_ms % 10) %}
												{{ weekly_leaders.fastest_time.username }} ({{ seconds }}.{{ "%02d"|format(centiseconds) }}{{ tenths }}s)
											{% elif weekly_leaders.fastest_time.time %}
												{{ weekly_leaders.fastest_time.username }} ({{ "%.1f"|format(weekly_leaders.fastest_time.time) }}s)
											{% else %}
												{{ weekly_leaders.fastest_time.username }}
											{% endif %}
										</p>
									</div>

																				<!-- Most improved -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Most improved</h4>
										<p class="font-size-md font-weight-md color-accent-white">Coming soon</p>
									</div>
								</div>
							</div>
						</div>

						<!-- WEEKLY STATS Column -->
						<div class="flex-column-desktop">
							<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-xl font-weight-xl color-accent-white">WEEKLY STATS</h3>
							<div id="hero-square" class="width-full-phone width-lg-tablet margin-auto-phone margin-auto-tablet border-radius shadow-green-md">
								<div class="flex-column-desktop flex-column-phone flex-justify-center flex-align-items-start width-full-all">
									
																				<!-- Total games played -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Total gams plaid</h4>
										<p class="font-size-md font-weight-md color-accent-white">{{ aggregated_stats.total_games }}</p>
									</div>

																				<!-- Total horses tranquilized -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Hors tranquilized</h4>
										<p class="font-size-md font-weight-md color-accent-white">{{ aggregated_stats.total_horses }}</p>
									</div>

																				<!-- Best time ever -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Best time evar</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{% if aggregated_stats.best_time_ever_ms %}
												{% set seconds = (aggregated_stats.best_time_ever_ms / 1000)|int %}
												{% set centiseconds = (aggregated_stats.best_time_ever_ms % 1000) // 10 %}
												{% set tenths = (aggregated_stats.best_time_ever_ms % 10) %}
												{{ seconds }}.{{ "%02d"|format(centiseconds) }}{{ tenths }}s
											{% elif aggregated_stats.best_time_ever %}
												{{ "%.1f"|format(aggregated_stats.best_time_ever) }}s
											{% else %}
												No data
											{% endif %}
										</p>
									</div>

																				<!-- Active players -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Active players</h4>
										<p class="font-size-md font-weight-md color-accent-white">{{ aggregated_stats.active_players }}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- REPORT STATS Column -->
						<div class="flex-column-desktop">
							<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-xl font-weight-xl color-accent-white rotate-right-desktop rotate-right-tablet">CRIME REPORTS</h3>
							<div id="hero-square" class="width-full-phone width-lg-tablet margin-auto-phone margin-auto-tablet border-radius rotate-right-desktop shadow-green-md">
								<div class="flex-column-desktop flex-column-phone flex-justify-center flex-align-items-start width-full-all">
									
									<!-- Most reported player -->
									<div class="data-item username-link flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet" {% if report_stats and report_stats.most_reported_player %}data-username="{{ report_stats.most_reported_player.username }}" style="cursor: pointer;"{% endif %}>
										<h4 class="font-size-md font-weight-xl color-accent-white">Most reported</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{% if report_stats and report_stats.most_reported_player %}
												{{ report_stats.most_reported_player.username }} ({{ report_stats.most_reported_player.report_count }})
											{% else %}
												No data
											{% endif %}
										</p>
									</div>

									<!-- Top reportar -->
									<div class="data-item username-link flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet" {% if report_stats and report_stats.top_reporter %}data-username="{{ report_stats.top_reporter.username }}" style="cursor: pointer;"{% endif %}>
										<h4 class="font-size-md font-weight-xl color-accent-white">Top reportar</h4>
										<p class="font-size-md font-weight-md color-accent-white">
											{% if report_stats and report_stats.top_reporter %}
												{{ report_stats.top_reporter.username }} ({{ report_stats.top_reporter.reports_made }})
											{% else %}
												No data
											{% endif %}
										</p>
									</div>
									
																				<!-- Total reports -->
											<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Total reports</h4>
										<p class="font-size-md font-weight-md color-accent-white">{{ report_stats.total_reports if report_stats else 0 }}</p>
									</div>

																													<!-- Cheat / Turd reports -->
									<div class="data-item data-item-disabled flex-row-desktop flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Cheats or turds</h4>
										<p class="font-size-md font-weight-md color-accent-white">{{ report_stats.cheat_reports if report_stats else 0 }} / {{ report_stats.turd_reports if report_stats else 0 }}</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Scores Section -->
				<div class="main-section margin-auto-desktop margin-auto-phone margin-auto-tablet width-full-desktop width-full-tablet width-full-phone bg-primary-dark-gradient" data-animate="page-intro">
											<div class="flex-column-desktop flex-column-phone flex-align-center flex-justify-center width-lg-desktop margin-auto-desktop margin-md-phone margin-auto-tablet gap-sm-all">
						<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-lg font-weight-xl color-accent-white text-center">GLOBAL SCOREBOARD</h3>
						
						<div class="overflow-scroll width-full-all">
						<table class="scoreboard-table margin-sm-desktop margin-sm-phone margin-sm-tablet width-full-all">
							<thead>
								<tr class="margin-sm-desktop margin-sm-phone margin-sm-tablet">
									<th class="font-size-sm font-weight-xl color-accent-white text-center">#</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-left">Username</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-center">Games</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-center">All hors</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-center">Best Time</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-center">HorsPass</th>
									<th class="font-size-sm font-weight-xl color-accent-white text-center">Subscription</th>
								</tr>
							</thead>
							<tbody>
								{% if scoreboard %}
									{% for entry in scoreboard %}
									<tr class="margin-sm-desktop margin-sm-phone margin-sm-tablet username-link" data-username="{{ entry.username }}" style="cursor: pointer;">
										<td class="font-size-md font-weight-xl {% if loop.index == 1 %}color-accent-gold{% elif loop.index == 2 %}color-accent-grey-mid{% else %}color-accent-white{% endif %} text-center">{{ loop.index }}</td>
										<td class="font-size-md font-weight-xl color-accent-white text-left">
											<h4 class="font-size-md font-weight-xl color-accent-white">{{ entry.username or 'Unknown' }}</h4>
										</td>
										<td class="font-size-md font-weight-md color-accent-white text-center">{{ entry.total_games or 0 }}</td>
										<td class="font-size-md font-weight-md color-accent-white text-center">{{ entry.total_horses or 0 }}</td>
										<td class="font-size-md font-weight-md color-accent-white text-center">
											{% if entry.best_time_ms %}
												{% set seconds = (entry.best_time_ms / 1000)|int %}
												{% set centiseconds = (entry.best_time_ms % 1000) // 10 %}
												{% set tenths = (entry.best_time_ms % 10) %}
												{{ seconds }}.{{ "%02d"|format(centiseconds) }}{{ tenths }}s
											{% elif entry.best_time_seconds %}
												{{ "%.1f"|format(entry.best_time_seconds) }}s
											{% else %}
												-
											{% endif %}
										</td>
										<td class="font-size-md font-weight-md color-accent-white text-center">Level {{ entry.horspass_level or 1 }}</td>
										<td class="font-size-md font-weight-md text-center">
											{% if entry.subscription_type == 'free' %}
												<div class="main-label font-size-sm font-weight-xl bg-accent-grey-mid color-accent-grey-dark width-lg-all margin-auto-all padding-md-all">
													<span class="font-size-sm">FREE</span>
												</div>
											{% elif entry.subscription_type == 'one' %}
												<div class="main-label main-label-one color-accent-white width-lg-all margin-auto-all padding-md-all width-max-all">
													<span class="font-size-sm">HORS ONE</span>
												</div>
											{% elif entry.subscription_type == 'plus' %}
												<div class="main-label main-label-plus color-accent-white width-lg-all margin-auto-all padding-md-all width-max-all">
													<span class="font-size-sm">HORS PLUS</span>
												</div>
											{% elif entry.subscription_type == 'max' %}
												<div class="main-label main-label-max color-accent-white width-lg-all margin-auto-all padding-md-all width-max-all">
													<span class="font-size-sm">HORS MAX</span>
												</div>
											{% else %}
												<div class="main-label font-size-sm font-weight-xl bg-accent-grey-mid color-accent-grey-dark width-lg-all margin-auto-all padding-md-all">
													<span class="font-size-sm">FREE</span>
												</div>
											{% endif %}
										</td>
									</tr>
									{% endfor %}
								{% else %}
									<tr class="margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<td colspan="7" class="font-size-md font-weight-md color-accent-white text-center">No scoreboard data available</td>
									</tr>
								{% endif %}
							</tbody>
						</table>
						</div> <!-- end overflow-scroll -->

					</div>
				</div>
			</div>
		

		</main> <!-- main-content -->

		<!-- User Profile Modal -->
		<div id="userProfileModal" class="modal-overlay" style="display: none;">
			<div class="modal-content">
				<div class="modal-header flex-row-all flex-justify-space-between flex-align-items-center padding-md-all">
					<h2 class="font-size-lg font-weight-xl color-accent-white">User Profile</h2>
					<button id="closeProfileModal" class="button shadow-red-sm font-weight-xl font-size-sm color-accent-white">✕</button>
				</div>
				<div id="modalProfileContent" class="padding-md-all">
					<!-- Profile content will be loaded here -->
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
		<script type="module" src="/static/js/main.js"></script> <!-- Resource jQuery -->
		<script>
			// Make logged in status available to JavaScript
			window.loggedIn = {{ 'true' if logged_in else 'false' }};
			
			// User Profile Modal functionality
			$(document).ready(function() {
				// Handle username clicks
				$('.username-link').on('click', function() {
					const username = $(this).data('username');
					if (username && username !== 'Unknown') {
						loadUserProfile(username);
					}
				});
				
				// Close modal handlers
				$('#closeProfileModal').on('click', function() {
					$('#userProfileModal').hide();
				});
				
				// Close modal when clicking overlay
				$('#userProfileModal').on('click', function(e) {
					if (e.target === this) {
						$(this).hide();
					}
				});
				
				// Close modal with Escape key
				$(document).on('keydown', function(e) {
					if (e.key === 'Escape') {
						$('#userProfileModal').hide();
					}
				});
				
				// Handle report player button clicks (using event delegation for dynamically created buttons)
				$(document).on('click', '#reportPlayerBtn', function() {
					const reportOptions = $('#reportPlayerOptions');
					
					// Toggle the report options visibility with 2x faster animation
					if (reportOptions.is(':visible')) {
						reportOptions.slideUp(150); // Default is 400ms, now 150ms (2.67x faster)
					} else {
						reportOptions.slideDown(150); // Default is 400ms, now 150ms (2.67x faster)
					}
				});
				
				// Handle report option button clicks
				$(document).on('click', '.report-option-btn', function() {
					const username = $(this).data('username');
					const reason = $(this).data('reason');
					const button = $(this);
					
					// Disable button during request
					button.prop('disabled', true).text('REPORTING...');
					
					// Submit report
					$.ajax({
						url: '/api/report-player',
						method: 'POST',
						contentType: 'application/json',
						data: JSON.stringify({
							reported_username: username,
							report_type: reason,
							context: 'scoreboard_modal'
						}),
						success: function(data) {
							if (data.success) {
								alert('✅ SUCCESS REPORTED! ' + username + ' for: ' + reason + '\n\nTHX for keepng teh community cleansed, HOSS!');
							} else {
								alert('❌ Error: ' + (data.message || data.error || 'Unknown error'));
							}
						},
						error: function(xhr) {
							let errorMsg = 'FAIL to submat repart';
							if (xhr.responseJSON && xhr.responseJSON.error) {
								errorMsg = xhr.responseJSON.error;
							}
							alert('❌ Error: ' + errorMsg);
						},
						complete: function() {
							// Re-enable button and hide options
							button.prop('disabled', false).text(reason);
							$('#reportPlayerOptions').slideUp(150);
						}
					});
				});
			});
			
			function loadUserProfile(username) {
				// Update modal header with username
				$('#userProfileModal .modal-header h2').html('Profil for <span class="color-accent-gold">' + username.toUpperCase() + '</span>');
				
				// Show modal with loading state
				$('#modalProfileContent').html('<div class="text-center padding-lg-all"><p class="color-accent-white font-size-md">Loading profile...</p></div>');
				$('#userProfileModal').show();
				
				// Make parallel API calls to get user profile and sessions
				$.when(
					$.ajax({
						url: '/api/user-profile/' + encodeURIComponent(username),
						method: 'GET'
					}),
					$.ajax({
						url: '/api/user-sessions/' + encodeURIComponent(username),
						method: 'GET'
					}).fail(function(xhr, status, error) {
						console.error('Sessions API Error:', status, error, xhr.responseText);
						// Return empty sessions array if sessions endpoint fails
						return { success: true, sessions: [] };
					})
				).done(function(profileResponse, sessionsResponse) {
					const profileData = profileResponse[0];
					const sessionsData = sessionsResponse[0];
					
					if (profileData.success) {
						renderUserProfile(profileData.user, sessionsData.success ? sessionsData.sessions : []);
					} else {
						$('#modalProfileContent').html('<div class="text-center padding-lg-all"><p class="color-accent-white font-size-md">Error loading profile: ' + (profileData.message || 'Unknown error') + '</p></div>');
					}
				}).fail(function(xhr, status, error) {
					console.error('Profile API Error:', status, error, xhr.responseText);
					$('#modalProfileContent').html('<div class="text-center padding-lg-all"><p class="color-accent-white font-size-md">Error loading profile. Please try again.</p></div>');
				});
			}
			
			function renderUserProfile(user, sessions = []) {
				const subscriptionBadge = getSubscriptionBadge(user.subscription_type);
				
				const profileHtml = `
					<!-- First Row: USER PROFILE and GAME STATS -->
					<div class="flex-row-desktop flex-column-phone flex-align-center flex-justify-space-between gap-xl-all">
						<!-- ACCOUNT DETAILS Column -->
						<div class="flex-column-desktop width-md-desktop width-full-phone width-full-tablet margin-auto-phone margin-auto-tablet">
							<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-lg font-weight-xl color-accent-white">USER PROFILE</h3>
							<div id="hero-square" class="width-full-all margin-auto-phone margin-auto-tablet border-radius shadow-green-md">
								<div class="flex-column-desktop flex-column-phone flex-justify-center flex-align-items-start width-full-desktop width-full-phone width-full-tablet padding-md-all">
									
									<!-- Username -->
									<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Username</h4>
										<div class="main-label bg-accent-gold color-accent-grey-dark padding-sm-all">
											<span class="font-size-sm">${user.username.toUpperCase()}</span>
										</div>
									</div>
									
									<!-- Member since -->
									<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Member since</h4>
										<div class="main-label bg-accent-gold color-accent-grey-dark padding-sm-all">
											<span class="font-size-sm">${user.member_since || 'UNKNOWN'}</span>
										</div>
									</div>
									
									<!-- Member type -->
									<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Member type</h4>
										${subscriptionBadge}
									</div>
									
									<!-- Reportod for cheatin -->
									<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Reportod for cheatin</h4>
										<p class="font-size-md font-weight-md color-accent-white">${user.cheatin_reports || 0}</p>
									</div>
									
									<!-- Reportd bcuz is turd -->
									<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
										<h4 class="font-size-md font-weight-xl color-accent-white">Reportd bcuz is turd</h4>
										<p class="font-size-md font-weight-md color-accent-white">${user.turd_reports || 0}</p>
									</div>
								</div>
							</div>
							
							<!-- Report Player Section -->
							<div class="flex-column-all flex-align-items-center width-full-all margin-md-desktop margin-sm-phone margin-md-tablet">
								<div class="flex-row-all">
									<button type="button" id="reportPlayerBtn" class="button shadow-red-sm font-weight-xl font-size-sm color-accent-white" data-username="${user.username}">REPORT PLAYR</button>
									<div id="reportPlayerOptions" class="flex-column-all flex-align-items-center width-full-all" style="display: none;">
										<div class="flex-row-all">
											<button type="button" class="report-option-btn button shadow-white-sm font-weight-xl font-size-sm color-accent-gold" data-reason="CHEATIN" data-username="${user.username}">CHEATIN</button>
											<button type="button" class="report-option-btn button shadow-white-sm font-weight-xl font-size-sm color-accent-gold" data-reason="IS A TURD" data-username="${user.username}">IS A TURD</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						
						<!-- STATS Column -->
						<div class="flex-column-all gap-xxl-all">
							<div class="flex-column-desktop width-full-phone width-full-tablet margin-auto-phone margin-auto-tablet">
								<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-lg font-weight-xl color-accent-white">GAME STATS</h3>
								<div id="hero-square" class="width-full-all margin-auto-phone margin-auto-tablet border-radius shadow-green-md">
									<div class="flex-column-desktop flex-column-phone flex-align-items-start flex-justify-center width-full-desktop padding-md-all">
										
										<!-- Games played -->
										<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
											<h4 class="font-size-md font-weight-xl color-accent-white">Games played</h4>
											<p class="font-size-md font-weight-md color-accent-white">${user.total_games || 0}</p>
										</div>
										
										<!-- Horses tranquilized -->
										<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
											<h4 class="font-size-md font-weight-xl color-accent-white">Horses tranquilized</h4>
											<p class="font-size-md font-weight-md color-accent-white">${user.total_horses || 0}</p>
										</div>
										
										<!-- Best time -->
										<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
											<h4 class="font-size-md font-weight-xl color-accent-white">Best time</h4>
											<p class="font-size-md font-weight-md color-accent-white">${user.best_time_ms ? (Math.floor(user.best_time_ms / 1000) + '.' + Math.floor((user.best_time_ms % 1000) / 10).toString().padStart(2, '0') + Math.floor((user.best_time_ms % 10)).toString() + 's') : (user.best_time_seconds ? user.best_time_seconds.toFixed(1) + 's' : 'No data')}</p>
										</div>
										
										<!-- HorsPass Level -->
										<div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
											<h4 class="font-size-md font-weight-xl color-accent-white">HorsPass Level</h4>
											<p class="font-size-md font-weight-md color-accent-white">Level ${user.horspass_level || 1}</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<!-- Second Row: RECENT GAMES -->
					<div class="flex-row-desktop flex-column-phone flex-align-center flex-justify-space-between gap-xl-all" style="margin-top: 2em;">
						<div class="flex-column-desktop width-full-desktop width-full-phone width-full-tablet margin-auto-phone margin-auto-tablet">
							<h3 class="margin-md-desktop margin-sm-phone margin-md-tablet font-size-lg font-weight-xl color-accent-white">RECENT GAMES</h3>
							${sessions.length > 0 ? generateRecentGamesBoxes(sessions) : '<p class="color-accent-white font-size-md text-center width-full-all">No recent games found</p>'}
						</div>
					</div>
				`;
				
				$('#modalProfileContent').html(profileHtml);
			}
			
			        function generateRecentGamesBoxes(sessions) {
            // Take only the latest 2 games
            const recentGames = sessions.slice(0, 2);
            
            const gameBoxes = recentGames.map((session, index) => {
                                                const date = new Date(session.created_at);
                                const formattedDate = date.toLocaleDateString();
                                
                                // Format duration with centisecond precision if available
                                let duration = 'N/A';
                                if (session.game_duration_ms && session.game_duration_ms > 0) {
                                    const seconds = Math.floor(session.game_duration_ms / 1000);
                                    const milliseconds = session.game_duration_ms % 1000;
                                    duration = seconds + '.' + Math.floor(milliseconds / 10).toString().padStart(2, '0') + Math.floor((milliseconds % 10)).toString() + 's';
                                } else if (session.game_duration_seconds && session.game_duration_seconds > 0) {
                                    duration = session.game_duration_seconds.toFixed(1) + 's';
                                }
                const targets = session.game_targets_popped || 0;
                const score = session.game_score || 0;
                const difficulty = session.game_difficulty || 'Unknown';
                const mode = session.game_mode || 'Unknown';
                const speed = session.game_modifier_speed || 1.0;
                const power = session.game_modifier_power || 50;
                const background = session.game_modifier_background || 'Unknown';

                return `
                    <!-- Game ${index + 1} Box -->
                    <div class="flex-column-desktop width-full-phone width-md-desktop width-full-tablet margin-auto-phone margin-auto-tablet">
                        <div id="hero-square" class="width-full-all margin-auto-phone margin-auto-tablet border-radius shadow-green-md">
                            <div class="flex-column-desktop flex-column-phone flex-align-items-start flex-justify-center width-full-desktop padding-md-all">
                                
                                <!-- Game Date -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Game date</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${formattedDate}</p>
                                </div>
                                
                                <!-- Game Time -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Game time</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${duration}</p>
                                </div>
                                
                                <!-- Score -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Score</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${score}</p>
                                </div>
                                
                                <!-- Targets -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Targets</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${targets}</p>
                                </div>
                                
                                <!-- Difficulty -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Difficulty</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${difficulty}</p>
                                </div>
                                
                                <!-- Mode -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Mode</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${mode}</p>
                                </div>
                                
                                <!-- Speed -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Speed</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${speed}x</p>
                                </div>
                                
                                <!-- Power -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Power</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${power}%</p>
                                </div>
                                
                                <!-- Background -->
                                <div class="data-item flex-row-desktop flex-row-tablet flex-row-phone flex-justify-space-between flex-align-items-center margin-sm-desktop margin-sm-phone margin-sm-tablet">
                                    <h4 class="font-size-md font-weight-xl color-accent-white">Background</h4>
                                    <p class="font-size-md font-weight-md color-accent-white">${background}</p>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="flex-row-desktop flex-column-tablet flex-column-phone flex-justify-space-between flex-align-items-start gap-xl-all">
                    ${gameBoxes}
                </div>
            `;
        }
			
			
			function getSubscriptionBadge(subscriptionType) {
				switch(subscriptionType) {
					case 'free':
						return '<div class="main-label font-size-sm font-weight-xl bg-accent-grey-mid color-accent-grey-dark padding-sm-all"><span class="font-size-sm">FREE</span></div>';
					case 'one':
						return '<div class="main-label main-label-one color-accent-white padding-sm-all"><span class="font-size-sm">HORS ONE</span></div>';
					case 'plus':
						return '<div class="main-label main-label-plus color-accent-white padding-sm-all"><span class="font-size-sm">HORS PLUS</span></div>';
					case 'max':
						return '<div class="main-label main-label-max color-accent-white padding-sm-all"><span class="font-size-sm">HORS MAX</span></div>';
					default:
						return '<div class="main-label font-size-sm font-weight-xl bg-accent-grey-mid color-accent-grey-dark padding-sm-all"><span class="font-size-sm">FREE</span></div>';
				}
			}
		</script>
		<script src="/static/js/secondary/username-editor.js"></script> <!-- Username editing functionality -->
		<script src="/static/js/secondary/account-button.js"></script> <!-- Account button avatar functionality -->
	</body>
</html>
